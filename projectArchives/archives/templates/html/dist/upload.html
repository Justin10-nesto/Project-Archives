{% load static %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
        crossorigin="anonymous">
    <title>AJAX + DJANGO File Uploader</title>
    <style>
      #myProgress {
        width: 100%;
    }
    #uploaded_files {
        margin-top: 25px;
        display: flex;
    }
    label {
        font-weight: bold;
    }
    .file-icon i {
        font-size: 60px;
        color: rgb(0, 0, 0);
    }
    .file-details {
        margin-top: -2px;
        padding-left: 10px;
        width: 100%;
    }
    .file-details p {
        margin-bottom: -7px;
    }
    small {
        margin-top: 0;
        color: black;
    }
    </style>
    {% comment %} <link rel="stylesheet" href="{% static 'css/app.css' %}"> {% endcomment %}
</head>
<body>
    <div class="col-lg-6 col-md-6" style="margin: 100px auto; display: block;">
        <div class="drop-box" id="dropBox" style="width: 100%; height: 400px; border: 4px dashed gray;" >
            <p style="text-align: center; vertical-align: middle; line-height: 400px; font-size: 24px; color: gray;">Drag & Drop to Upload File</p>
        </div>
        <form enctype="multipart/form-data" method="POST" action="" style="text-align: center;">
            <p style="color: gray; padding-top: 20px;">or</p>
            {% csrf_token %}
            <div class="form-group">
                <label>Select file to upload.</label>
                <input type="file" class="form-control" id="fileupload" placeholder="Select file">
            </div>
            <input type="submit" value="Upload" id="submit" class="btn btn-success">     
        </form>
        <div id="uploaded_files"></div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    {% comment %} <script src="{% static 'js/app.js' %}"></script> {% endcomment %}

    <script>
      class FileUpload {

        constructor(input) {
            this.input = input
            this.max_length = 1024 * 1024 * 10;
        }
    
        create_progress_bar() {
            var progress = `<div class="file-icon">
                                <i class="fa fa-file-o" aria-hidden="true"></i>
                            </div>
                            <div class="file-details">
                                <p class="filename"></p>
                                <small class="textbox"></small>
                                <div class="progress" style="margin-top: 5px;">
                                    <div class="progress-bar bg-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                                    </div>
                                </div>
                            </div>`
            document.getElementById('uploaded_files').innerHTML = progress
        }
    
        upload() {
            this.create_progress_bar();
            this.initFileUpload();
        }
    
        initFileUpload() {
            this.file = this.input.files[0];
            this.upload_file(0, null);
        }
    
        //upload file
        upload_file(start, model_id) {
            var end;
            var self = this;
            var existingPath = model_id;
            var formData = new FormData();
            var nextChunk = start + this.max_length + 1;
            var currentChunk = this.file.slice(start, nextChunk);
            var uploadedChunk = start + currentChunk.size
            if (uploadedChunk >= this.file.size) {
                end = 1;
            } else {
                end = 0;
            }
            formData.append('file', currentChunk)
            formData.append('filename', this.file.name)
            $('.filename').text(this.file.name)
            $('.textbox').text("Uploading file")
            formData.append('end', end)
            formData.append('existingPath', existingPath);
            formData.append('nextSlice', nextChunk);
            $.ajaxSetup({
                headers: {
                    "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
                }
            });
            $.ajax({
                xhr: function () {
                    var xhr = new XMLHttpRequest();
                    xhr.upload.addEventListener('progress', function (e) {
                        if (e.lengthComputable) {
                            if (self.file.size < self.max_length) {
                                var percent = Math.round((e.loaded / e.total) * 100);
                            } else {
                                var percent = Math.round((uploadedChunk / self.file.size) * 100);
                            }
                            $('.progress-bar').css('width', percent + '%')
                            $('.progress-bar').text(percent + '%')
                        }
                    });
                    return xhr;
                },
    
                url: '/upload/',
                type: 'POST',
                dataType: 'json',
                cache: false,
                processData: false,
                contentType: false,
                data: formData,
                error: function (xhr) {
                    alert(xhr.statusText);
                },
                success: function (res) {
                    if (nextChunk < self.file.size) {
                        // upload file in chunks
                        existingPath = res.existingPath
                        self.upload_file(nextChunk, existingPath);
                    } else {
                        // upload complete
                        $('.textbox').text(res.data);
                        alert(res.data)
                    }
                }
            });
        };
    }
    
    (function ($) {
        $('#submit').on('click', (event) => {
            event.preventDefault();
            var uploader = new FileUpload(document.querySelector('#fileupload'))
            console.log(document.querySelector('#fileupload'));
            uploader.upload();
        });
    })(jQuery);
    
    ondragenter = function(evt) {
        evt.preventDefault();
        evt.stopPropagation();
    };
    
    ondragover = function(evt) {
        evt.preventDefault();
        evt.stopPropagation();
    };
    
    ondragleave = function(evt) {
        evt.preventDefault();
        evt.stopPropagation();
    };
      
    ondrop = function(evt) {
        evt.preventDefault();
        evt.stopPropagation();
        const files = evt.originalEvent.dataTransfer;
        var uploader = new FileUpload(files);
        uploader.upload();
    };
    
    $('#dropBox')
        .on('dragover', ondragover)
        .on('dragenter', ondragenter)
        .on('dragleave', ondragleave)
        .on('drop', ondrop);
  </script>    
</body>
</html>